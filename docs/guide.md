# Text Generation Guide

We assume that Accelerated Text environment is already running and can be reached at http://localhost:8080. If not, please refer to [Setting up the environment](docs/environemnt.md).

## Create Document Plan

Follow the step by step guide bellow to create a very simple document plan which generates book authorship sentences.

| View | Step |
| ------ | ------ |
| <img src="docs/assets/create-plan.png" width="300"/> | Press _Create a new document plan_ in the upper left corner of the screen. |
| <img src="docs/assets/empty-doc-plan.png" width="200"/> | Make sure that an empty document plan similar to the one pictured on the left has appeared in the workspace. |
| <img src="docs/assets/csv-file-selection.png" width="200"/> | Select bundled sample _books.csv_ file in Data section on the right. |
| <img src="docs/assets/text-segment.png" width="200"/> | Select _Text Segment_ block by pressing left mouse button on it. |
| <img src="docs/assets/quick-menu.png" width="300"/> | Open block search menu by pressing "CTRL + ,". |
| <img src="docs/assets/author-amr-block-search.png" width="300"/> | Type "author" and select pink _Abstract Meaning Representation_ block. |
| <img src="docs/assets/amr.png" width="300"/> | Press on newly appeared "author" block and open search menu again ("CTRL + ,"). |
| <img src="docs/assets/search-authors.png" width="300"/> | Select green "authors" data block which is our _Agent_ in this case. |
| <img src="docs/assets/search-title.png" width="300"/> | Repeat the same process to select "title" data block which will represent _Co-Agent_. |
| <img src="docs/assets/complete-plan.png" width="300"/> | The plan is ready by now and should look like the picture on the left. |
| <img src="docs/assets/generation-results.png" width="300"/> | Navigate to _Text Analysis_ section to see text variations generated by the natural language generation engine. |

## GraphQL API

You should have running accelerated text environment and simple document plan created by now, if not, please refer to previous sections.
 
Here we will describe Accelerated Text GraphQL API usage in order to fetch generated texts. For this purpose we will need to pass two bits of information to the NLG backend: *document plan identifier* and *data item identifier*.

The GraphQL endpoint is accessible at `http://localhost:3001/_graphql`. CURL will be used to illustrate the calls to the back end.

First lets get registered document plans:

```
curl -X POST -H "Content-Type: application/json" \
  --data '{"query": "{documentPlans(offset:0 limit:10){totalCount items{id name dataSampleId dataSampleRow}}}" }' \
  http://localhost:3001/_graphql
```

This will return a list of document plans:

```json
{
  "data": {
    "documentPlans": {
      "totalCount": 1,
      "items": [
        {
          "id": "e39836ed-0283-4080-a436-554d9c48b839",
          "name": "Book store",
          "dataSampleId": "ba177b94-1963-4e21-979d-bf0cba75e05c",
          "dataSampleRow": 0
        }
      ]
    }
  }
}
```

The `id` field gives document plan id, and the `dataSampleId` field specifies which data to use. Using these fields we construct a text generation request.
With this, a second call has to be made to get the results identifier for actual sentence polling. Polling is used because text is not generated right away, NLG process for a more complcated plans can take some time.

```
curl -XPOST -H "Content-Type: application/json" \
  --data '{"documentPlanId":"e39836ed-0283-4080-a436-554d9c48b839","dataId":"ba177b94-1963-4e21-979d-bf0cba75e05c"}' \
  http://localhost:3001/nlg/ 
```

A result id is returned:

```json
{"resultId": "6f26099d-429d-41e9-9800-83ab58c59ddd"}
```

With this a final request can be made to fetch the results. Note that it can be done repeatedly with high performance, since the text generation is not happening at this stage.

```
curl -XGET -H "Content-Type: application/json" http://localhost:3001/nlg/6f26099d-429d-41e9-9800-83ab58c59ddd
```

You should get generated text with annotations (data is truncated):

```json
{
  "offset": 0,
  "totalCount": 2,
  "ready": true,
  "variants": [
    {
      "type": "ANNOTATED_TEXT",
      "id": "ae9a1d60-4aa6-49da-9738-480243a5095b",
      "children": [
        {
          "type": "PARAGRAPH",
          "id": "ab8b650a-8774-4992-8a56-fe8d01f74097",
          "children": [
            {
              "type": "SENTENCE",
              "id": "5cda3e9f-8fad-4b69-a0a3-f9f5e9a19465",
              "children": [
                {
                  "type": "WORD",
                  "id": "db5c71ec-f893-4406-8a3f-e91ca6aa08dc",
                  "text": "Building"
                },
                {
                  "type": "WORD",
                  "id": "84e164c7-1fd0-4f18-b120-8a4f7563741b",
                  "text": "Search"
                },
                {
                  "type": "WORD",
                  "id": "2e54b4b1-ed52-4689-8f5f-0a06ec8a35b5",
                  "text": "Applications"
                }
              ]
            }
          ]
        }
      ]
    }
  ]
}
```

## Clojure API use

Accelerated Text UI helps with creating document plans and testing them with sample data. 
Accelerated Text's generation functionality can be used directly from the Clojure code.

Lets say you have a book data limited to the author and the book title:

| title                       | authors       |
| -----                       | ------        |
| Frankenstein                | M. W. Shelley |
| Dracula                     | Bram Stoker   |
| The Island of Doctor Moreau | H.G. Wells    |

When working via UI this data needs to be uploaded as the CSV. To use it in the code we'll have to represent it as a Clojure map. 

```clojure
(def data
  [{:title   "Frankenstein"
    :authors "M. W. Shelley"}
   {:title   "Dracula"
    :authors "Bram Stoker"}
   {:title   "The Island of Doctor Moreau"
    :authors "H.G. Wells"}])
```

Second component needed for generation is the plan itself. In UI it has a nice representation in visual blocks, and is persisted in the structure like this:

```clojure
(def document-plan
  {:type     "Document-plan"
   :segments [{:type     "Segment"
               :children [{:type           "AMR"
                           :conceptId      "author"
                           :dictionaryItem {:type   "Dictionary-item"
                                            :itemId "author"
                                            :name   "author"}
                           :roles          [{:name     "agent"
                                             :children [{:name "authors"
                                                         :type "Cell"}]}
                                            {:name     "co-agent"
                                             :children [{:name "title"
                                                         :type "Cell"}]}
                                            {:name "theme" :children [nil]}]}]}]})
```

State needs to be initialized