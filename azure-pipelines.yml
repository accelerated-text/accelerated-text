trigger:
- master

pr:
- master

jobs:
  - job: unit_test_backend
    pool:
      vmImage: 'ubuntu-latest'
    container: clojure:tools-deps-alpine
    steps:
      - script: |
          cd core
          clojure -Sdeps -A:test -e integration

      - script: |
          cd api
          clojure -Sdeps -A:test -e integration

  - job: lint_backend
    pool:
      vmImage: 'ubuntu-latest'
    container: borkdude/clj-kondo:latest
    steps:
      - script: |
          cd api
          clj-kondo --lint src test
      - script: |
          cd core
          clj-kondo --lint src test

  - job: test_frontend
    pool:
      vmImage: 'ubuntu-latest'
    steps:
      - task: NodeTool@0
        inputs:
          versionSpec: '11'
      - script:
          npm install
      - script:
          npm test --silent
      
  - job: integration_tests
    pool:
      vmImage: 'ubuntu-latest'
    steps:
      - task: DockerCompose@0
        displayName: Build Integration tests dependencies
        inputs:
          dockerComposeFile: api/docker-compose.test.yml
          projectName: $(Build.Repository.Name)
          dockerComposeCommand: build

      - task: DockerCompose@0
        displayName: Run Integration tests
        inputs:
          dockerComposeFile: api/docker-compose.test.yml
          projectName: $(Build.Repository.Name)
          dockerComposeCommand: up --remove-orphans --abort-on-container-exit --exit-code-from api

  - job: eval
    pool:
      vmImage: 'ubuntu-latest'
    steps:
      - checkout: self
        submodules: true
      - task: DockerCompose@0
        displayName: Build Eval
        inputs:
          dockerComposeFile: docker-compose.yml
          additionalDockerComposeFiles: docker-compose.eval.yml
          projectName: $(Build.Repository.Name)
          dockerComposeCommand: build

      - task: DockerCompose@0
        displayName: Run Eval
        inputs:
          dockerComposeFile: docker-compose.yml
          additionalDockerComposeFiles: docker-compose.eval.yml
          projectName: $(Build.Repository.Name)
          dockerComposeCommand: up --remove-orphans --abort-on-container-exit --exit-code-from eval
